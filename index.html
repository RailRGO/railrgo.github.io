<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Запись на уроки по математике и физике | Абубакиров Василий Владимирович</title>
  <meta name="description" content="Онлайн-запись на индивидуальные уроки по математике и физике. Длительность 50 минут.">
  <style>
    :root{--bg:#fff;--text:#1b1b1b;--muted:#6b7280;--card:#f8fafc;--accent:#2563eb}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:var(--bg)}
    header,section,footer{max-width:900px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    nav a{margin-left:16px;color:var(--text);text-decoration:none;font-weight:600}
    .btn{display:inline-block;background:var(--accent);color:#fff;padding:12px 18px;border-radius:10px;text-decoration:none;font-weight:600;border:0;cursor:pointer}
    .card{background:var(--card);padding:20px;border-radius:14px}
    .grid{display:grid;gap:14px} .two{grid-template-columns:1fr 1fr} @media(max-width:720px){.two{grid-template-columns:1fr}}
    input,select,textarea{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px}
    label{font-weight:600;font-size:14px}
    .muted{color:var(--muted);font-size:14px}
    .success{background:#ecfdf5;color:#065f46;padding:12px;border-radius:10px}
    .error{background:#fef2f2;color:#991b1b;padding:12px;border-radius:10px}
    small.badge{background:#eef2ff;color:#3730a3;padding:2px 8px;border-radius:999px}
  </style>
</head>
<body>
<header>
  <div style="font-weight:800">Абубакиров Василий Владимирович</div>
  <nav>
    <a href="#schedule">Запись</a>
    <a href="#about">Обо мне</a>
    <a href="#contacts">Контакты</a>
  </nav>
</header>

<section class="card">
  <h1>Уроки по математике и физике</h1>
  <p class="muted">
    Длительность занятия — 50 минут. Рабочие часы: пн–сб, 18:00–22:00 по Москве (Europe/Moscow).
    Слоты ниже отображаются в вашем часовом поясе.
  </p>
  <p><a class="btn" href="#schedule">Записаться</a></p>
</section>

<section id="schedule">
  <h2>Запись на занятие</h2>
  <div class="card">
    <form id="bookingForm" class="grid" autocomplete="on">
      <div class="two grid">
        <div>
          <label for="name">Имя</label>
          <input id="name" name="name" required placeholder="Иван Иванов">
        </div>
        <div>
          <label for="email">Email</label>
          <input id="email" name="email" type="email" required placeholder="name@example.com">
        </div>
      </div>

      <div class="two grid">
        <div>
          <label for="subject">Предмет</label>
          <select id="subject" name="subject">
            <option>Математика</option>
            <option>Физика</option>
          </select>
        </div>
        <div>
          <label for="date">Дата (ваш часовой пояс: <span id="tzLabel"></span>)</label>
          <input id="date" name="date" type="date" required>
          <div class="muted">Учитываются рабочие дни преподавателя по Москве: пн–сб.</div>
        </div>
      </div>

      <div>
        <label for="time">Время слота</label>
        <select id="time" name="time" required></select>
        <div class="muted">Отображение: локальное время — эквивалент <b>18:00–22:00 МСК</b> выбранного дня.</div>
      </div>

      <div>
        <label for="message">Комментарий (необязательно)</label>
        <input id="message" name="message" placeholder="Пожелания по теме, уровень и т.д.">
      </div>

      <div id="status"></div>
      <div>
        <button class="btn" type="submit">Проверить и записаться</button>
      </div>
    </form>
  </div>
</section>

<section id="about">
  <h2>Обо мне</h2>
  <div class="card">
    <p>Репетитор по математике и физике. Готовлю к экзаменам, помогаю подтянуть школьную программу и углубиться в предмет. Формат занятий — онлайн. Длительность урока — 50 минут.</p>
  </div>
</section>

<section id="contacts">
  <h2>Контакты</h2>
  <div class="card">
    <p><a class="btn" style="background:#0088cc" href="https://t.me/aviation09" target="_blank" rel="noopener">Связаться в Telegram (@aviation09)</a></p>
    <p class="muted">Приглашение придёт на указанный email автоматически.</p>
  </div>
</section>

<footer>
  <small>© 2025 Абубакиров Василий Владимирович</small>
</footer>

<script>
  // URL вашего Apps Script Web App:
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwtEwIK2iat73soses37hWC-HKNuDlBdHs_4YDLNTUVMU675Oilm_cr-bFqixa-0BhYQw/exec';

  // Настройки расписания (времена — в часовом поясе преподавателя)
  const TUTOR_TZ = 'Europe/Moscow';
  const WORK_DAYS = [1,2,3,4,5,6]; // 1=пн ... 7=вс
  const START_HOUR = 18;            // 18:00 МСК
  const END_HOUR = 22;              // до 22:00 (последний старт 21:00)
  const SLOT_DURATION_MIN = 50;

  const tzUser = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local';
  document.getElementById('tzLabel').textContent = tzUser;

  const dateEl = document.getElementById('date');
  const timeEl = document.getElementById('time');
  const statusEl = document.getElementById('status');

  // Минимальная дата — сегодня
  const todayLocal = new Date();
  dateEl.min = toYmd(todayLocal);

  // Выбираем ближайшую дату, допустимую по мск-расписанию
  const initialLocal = nextAllowedLocalDate(todayLocal);
  dateEl.value = toYmd(initialLocal);

  dateEl.addEventListener('change', () => {
    const d = new Date(dateEl.value + 'T12:00:00');
    if (!isAllowedLocalDate(d)) {
      const next = nextAllowedLocalDate(d);
      dateEl.value = toYmd(next);
    }
    populateTimes();
  });

  populateTimes();

  function showStatus(html, type) {
    statusEl.className = type === 'error' ? 'error' : (type === 'success' ? 'success' : '');
    statusEl.innerHTML = html;
  }

  // Проверяем, является ли локальная дата допустимой с точки зрения дня недели преподавателя (по МСК)
  function isAllowedLocalDate(localNoonDate) {
    const wk = weekdayNumInTZ(localNoonDate, TUTOR_TZ); // 1..7
    return WORK_DAYS.includes(wk);
  }

  function nextAllowedLocalDate(fromLocalDate) {
    const d = new Date(fromLocalDate);
    d.setHours(12,0,0,0); // полдень
    while (!isAllowedLocalDate(d) || toYmd(d) < toYmd(todayLocal)) {
      d.setDate(d.getDate() + 1);
    }
    return d;
  }

  function toYmd(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }

  function weekdayNumInTZ(dateLocal, tz) {
    const w = new Intl.DateTimeFormat('en-GB', { timeZone: tz, weekday: 'short' }).format(dateLocal);
    const map = {Mon:1, Tue:2, Wed:3, Thu:4, Fri:5, Sat:6, Sun:7};
    return map[w];
  }

  // Получить YYYY,MM,DD дня в МСК, соответствующего локальной дате (берём полдень, чтобы не перепрыгивать дни)
  function mskYmdFromLocalYmd(localYmd) {
    const localNoon = new Date(localYmd + 'T12:00:00');
    const y = Number(new Intl.DateTimeFormat('en-CA', { timeZone: TUTOR_TZ, year:'numeric' }).format(localNoon));
    const m = Number(new Intl.DateTimeFormat('en-CA', { timeZone: TUTOR_TZ, month:'2-digit' }).format(localNoon));
    const d = Number(new Intl.DateTimeFormat('en-CA', { timeZone: TUTOR_TZ, day:'2-digit' }).format(localNoon));
    return { y, m, d };
  }

  // Построить Date, представляющую момент "y-m-d h:mm" в часовом поясе tz (без библиотек)
  function makeZonedDate(y, m, d, hh, mm, tz) {
    const dtf = new Intl.DateTimeFormat('en-US', {
      timeZone: tz, hour12: false,
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
    let utc = Date.UTC(y, m-1, d, hh, mm, 0);
    // Итеративно корректируем до совпадения локальных компонент
    for (let i = 0; i < 3; i++) {
      const parts = Object.fromEntries(dtf.formatToParts(new Date(utc)).map(p => [p.type, p.value]));
      const ay = Number(parts.year), am = Number(parts.month), ad = Number(parts.day);
      const ah = Number(parts.hour), ami = Number(parts.minute), as = Number(parts.second);
      const desired = Date.UTC(y, m-1, d, hh, mm, 0);
      const actual  = Date.UTC(ay, am-1, ad, ah, ami, as);
      const diff = desired - actual;
      if (diff === 0) break;
      utc += diff;
    }
    return new Date(utc);
  }

  function populateTimes() {
    timeEl.innerHTML = '';
    const localYmd = dateEl.value;
    if (!localYmd) return;

    // День в МСК для выбранной локальной даты
    const { y, m, d } = mskYmdFromLocalYmd(localYmd);

    // Проверим рабочий день в МСК
    const mskNoon = makeZonedDate(y, m, d, 12, 0, TUTOR_TZ);
    if (!WORK_DAYS.includes(weekdayNumInTZ(mskNoon, TUTOR_TZ))) {
      showStatus('В этот день (по МСК) запись не ведётся. Выбран ближайший доступный.', 'error');
      const next = nextAllowedLocalDate(new Date(localYmd + 'T12:00:00'));
      dateEl.value = toYmd(next);
      return populateTimes();
    }

    const now = new Date();
    let count = 0;
    for (let h = START_HOUR; h < END_HOUR; h++) {
      // Слот: h:00 по МСК → в локальное время пользователя
      const slotStart = makeZonedDate(y, m, d, h, 0, TUTOR_TZ); // абсолютное время
      if (slotStart.getTime() < now.getTime() + 2*60000) continue; // прошедшие слоты не показываем

      const localLabel = slotStart.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
      const mskLabel = String(h).padStart(2,'0') + ':00 МСК';

      const opt = document.createElement('option');
      opt.value = slotStart.toISOString(); // будем отправлять ISO, без пересчётов
      opt.textContent = `${localLabel} (=${mskLabel})`;
      timeEl.appendChild(opt);
      count++;
    }

    if (!count) {
      showStatus('На выбранную дату (по МСК) свободных слотов не осталось. Выберите другой день.', 'error');
    } else {
      showStatus('', '');
    }
  }

  document.getElementById('bookingForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    showStatus('Отправляем запрос…', '');

    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const subject = document.getElementById('subject').value.trim();
    const message = document.getElementById('message').value.trim();
    const startIso = document.getElementById('time').value; // уже ISO UTC из опции

    if (!startIso) {
      showStatus('Выберите время слота', 'error');
      return;
    }

    const payload = { name, email, subject, message, startIso, timezone: tzUser };

    try {
      const res = await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // без preflight
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (!data.ok) {
        if (data.reason === 'busy') {
          showStatus('Это время уже занято. Пожалуйста, выберите другое.', 'error');
        } else if (data.reason === 'closed') {
          showStatus('Запись доступна пн–сб с 18:00 до 22:00 по Москве. Выберите другое время.', 'error');
        } else if (data.reason === 'past') {
          showStatus('Нельзя записаться на прошедшее время. Выберите другой слот.', 'error');
        } else {
          showStatus('Ошибка: ' + (data.error || 'неизвестно'), 'error');
        }
        return;
      }

      const start = new Date(data.startIso);
      const end = new Date(data.endIso);

      showStatus(
        `Готово! Вы записаны на <b>${start.toLocaleString()}</b> (50 минут).<br>
         Приглашение отправлено на <b>${email}</b> (проверьте «Входящие/Спам»).`,
        'success'
      );
      e.target.reset();
      populateTimes();
    } catch (err) {
      showStatus('Не удалось отправить заявку. Проверьте интернет и попробуйте снова.', 'error');
      console.error(err);
    }
  });
</script>
</body>
</html>
