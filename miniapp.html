<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Онлайн‑уроки — Mini App</title>
  <meta name="theme-color" content="#0b1020" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0b1020; --text:#e5e7eb; --muted:#a8b3c2;
      --card:rgba(255,255,255,0.06); --border:rgba(255,255,255,0.16);
      --accent:#6366f1; --accent-2:#8b5cf6; --accent-g:#16a085;
      --chip:#121a2f; --chip-br:#2b3551; --chip-text:#0f172a; --chip-meta:#6b7280;
      --slot-bg:#ffffff; --slot-br:#e5e7eb; --slot-text:#0f172a; --slot-meta:#64748b;
      --shadow: 0 10px 26px rgba(0,0,0,.35);
      color-scheme: dark;
    }
    [data-theme="light"]{
      --bg:#f8fafc; --text:#0f172a; --muted:#475569;
      --card:#ffffff; --border:#e5e7eb;
      --accent:#6366f1; --accent-2:#8b5cf6; --accent-g:#10b981;
      --chip:#ffffff; --chip-br:#e5e7eb;
      --slot-bg:#ffffff; --slot-br:#e5e7eb; --slot-text:#0f172a; --slot-meta:#64748b;
      --shadow: 0 8px 22px rgba(2,6,23,.08);
      color-scheme: light;
    }
    html,body{height:100%}
    body{
      margin:0; padding:16px;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text); background: var(--bg); position: relative; overflow-x:hidden;
    }
    body::before{
      content:""; position: fixed; inset:-40vh -40vw -40vh -40vw; z-index:-1; pointer-events:none;
      background:
        radial-gradient(60% 40% at 120% -10%, rgba(99,102,241,.12), transparent 60%),
        radial-gradient(45% 30% at -10% 120%, rgba(16,185,129,.10), transparent 60%);
      background-repeat:no-repeat; background-size: 100% 100%;
    }
    .wrap{ max-width:860px; margin:0 auto; }
    h2{ margin:0 0 8px; font-weight:800; letter-spacing:.2px }
    .muted{ color:var(--muted); font-size:13px }

    .tabs{ display:flex; gap:12px; margin:14px 0 16px }
    .tab{ padding:10px 14px; border:1px solid var(--border); border-radius:14px; background:var(--card); color:var(--text); font-weight:800; cursor:pointer }
    .tab.active{ outline:2px solid var(--accent) }

    .panel{
      background: linear-gradient(135deg, rgba(99,102,241,.08), rgba(16,185,129,.08));
      border:1px solid var(--border); border-radius:18px; padding:16px; box-shadow: var(--shadow);
    }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin: 2px 0 10px }
    label{ font-size:14px; font-weight:800 }
    input[type="date"]{ padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:var(--card); color:var(--text); outline:none }
    input[type="date"]:focus{ border-color:#7c83ff; box-shadow:0 0 0 6px rgba(99,102,241,.25) }

    .subjects{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; margin: 14px 0 12px }
    .subj{
      padding:12px 14px; border-radius:16px; border:1px solid var(--chip-br);
      background: var(--chip); color:var(--text); font-weight:800; cursor:pointer; text-align:center;
      box-shadow: 0 4px 12px rgba(2,6,23,.12); transition: transform .08s ease, box-shadow .12s ease;
    }
    .subj:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(2,6,23,.16); }
    .subj.active{
      border-color:transparent;
      background: linear-gradient(135deg, var(--accent), var(--accent-g));
      color:#fff; box-shadow: 0 10px 22px rgba(99,102,241,.35);
    }

    #secMy #myList{ display:flex; flex-direction:column; gap:14px }
    #secMy #myList .item{ width:100%; box-sizing:border-box }
    #secMy #myList .actions{ display:flex; gap:12px; flex-wrap:wrap; justify-content:flex-start }

    #slots{ display:grid; grid-template-columns:1fr; gap:14px; margin-top:14px }
    .slot{
      display:flex; flex-direction:column; gap:6px; padding:16px;
      background: var(--slot-bg); border:1px solid var(--slot-br); border-radius:18px; cursor:pointer;
      box-shadow: 0 6px 16px rgba(2,6,23,.10); transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease, background-color .12s ease;
    }
    .slot:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(2,6,23,.14); }
    .slot .time{ font-size:18px; font-weight:800; letter-spacing:.2px; color:var(--slot-text) }
    .slot .meta{ font-size:13px; color:var(--slot-meta); font-weight:600 }
    .slot.selected{
      border-color: transparent;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color:#fff; box-shadow: 0 12px 24px rgba(99,102,241,.35)
    }
    .slot.selected .time, .slot.selected .meta{ color:#fff }

    .item{ border:1px solid var(--border); border-radius:16px; padding:12px 14px; background:var(--card) }
    .actions{ display:flex; gap:12px; margin-top:12px; flex-wrap:wrap }
    .btn{ padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:transparent; color:var(--text); font-weight:800; cursor:pointer }
    .btn.destructive{ border:none; background: linear-gradient(135deg,#ef4444,#f97316); color:#fff }

    .info{ padding:10px 12px; border-left:3px solid var(--accent); background:rgba(99,102,241,.10); border-radius:10px; margin:12px 0 10px }
    .loading{ display:inline-flex; align-items:center; gap:10px; color:var(--muted) }
    .spinner{ width:16px; height:16px; border-radius:50%; border:2px solid var(--border); border-top-color:#7c83ff; animation:spin .8s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    .fallback{ position:fixed; left:12px; right:12px; bottom:12px; background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; display:none }
    .fallback a{ font-weight:800; color:#b9c2ff; text-decoration:none; display:inline-block; margin-top:6px }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Запись на урок</h2>
    <div class="muted" id="userNote">Откройте в Telegram, чтобы авторизоваться</div>

    <div class="tabs">
      <button class="tab active" id="tabBook">Записаться</button>
      <button class="tab" id="tabMy">Мои записи</button>
    </div>

    <div id="reschedInfo" class="info" style="display:none;"></div>

    <section id="secBook" class="panel">
      <div class="row">
        <label for="date" id="dateLabel">Дата:</label>
        <input id="date" type="date" />
      </div>

      <div class="subjects" id="subjects">
        <button class="subj active" data-value="Математика">Математика</button>
        <button class="subj" data-value="Физика">Физика</button>
      </div>

      <div id="slotsWrap">
        <div id="slotsStatus" class="loading"><span class="spinner"></span><span>Загружаем слоты…</span></div>
        <div id="slots"></div>
      </div>
    </section>

    <section id="secMy" class="panel" style="display:none; margin-top:16px">
      <div id="myList" class="loading"><span class="spinner"></span><span>Загружаем…</span></div>
    </section>
  </div>

  <div class="fallback" id="fallbackBox">
    <div>Это мини‑приложение Telegram. Откройте его из бота, чтобы авторизоваться и записаться.</div>
    <a id="fallbackLink" href="#" target="_blank" rel="noopener">Открыть в боте</a>
  </div>

  <script>
    const API = 'https://script.google.com/macros/s/AKfycbx7qRWAP1zARUxp-D4_xT72Aym7y7ll1W9hepEL0I4U5DvTali1mjrk8sV6DknLNHEdIA/exec';
    const BOT_USERNAME = 'TutorAVVbot';

    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    const inTG = !!(tg && tg.initData);
    if (inTG) { tg.ready(); tg.expand(); }

    if (inTG) {
      const dark = (tg.colorScheme || '').toLowerCase() !== 'light';
      document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
      const tp = tg.themeParams || {};
      if (tp.bg_color)     document.documentElement.style.setProperty('--bg', tp.bg_color);
      if (tp.text_color)   document.documentElement.style.setProperty('--text', tp.text_color);
      if (tp.hint_color)   document.documentElement.style.setProperty('--muted', tp.hint_color);
      if (tp.button_color) document.documentElement.style.setProperty('--accent', tp.button_color);
    }

    const fallbackBox = document.getElementById('fallbackBox');
    const fallbackLink = document.getElementById('fallbackLink');
    if (!inTG) { fallbackBox.style.display = 'block'; fallbackLink.href = `https://t.me/${BOT_USERNAME}?startapp=open`; }

    const userNote = document.getElementById('userNote');
    const tabBook = document.getElementById('tabBook');
    const tabMy = document.getElementById('tabMy');
    const secBook = document.getElementById('secBook');
    const secMy = document.getElementById('secMy');
    const reschedInfo = document.getElementById('reschedInfo');

    const dateEl = document.getElementById('date');
    const dateLabel = document.getElementById('dateLabel');
    const subjectsEl = document.getElementById('subjects');
    const slots = document.getElementById('slots');
    const slotsStatus = document.getElementById('slotsStatus');
    const myList = document.getElementById('myList');

    let user = null;
    if (inTG && tg.initDataUnsafe && tg.initDataUnsafe.user) {
      user = tg.initDataUnsafe.user;
      const name = [user.first_name, user.last_name].filter(Boolean).join(' ');
      userNote.textContent = `${name}${user.username ? ' @'+user.username : ''} • MSK`;
    }

    let selected = null;
    let rescheduleFrom = null;
    let selectedSubject = 'Математика';

    tabBook.onclick = () => switchTab('book');
    tabMy.onclick   = () => switchTab('my');
    function switchTab(which){
      tabBook.classList.toggle('active', which==='book');
      tabMy.classList.toggle('active',   which==='my');
      secBook.style.display = which==='book' ? '' : 'none';
      secMy.style.display   = which==='my' ? '' : 'none';
      if (inTG) tg.MainButton.hide();
      if (which==='my') loadMy();
    }
    const urlParams = new URLSearchParams(location.search);
    if (urlParams.get('tab') === 'my') switchTab('my');

    function mskTodayIso(){
      return new Intl.DateTimeFormat('en-CA', { timeZone:'Europe/Moscow', year:'numeric', month:'2-digit', day:'2-digit' }).format(new Date());
    }
    function ruDateLabel(ymd){
      const [y,m,d] = ymd.split('-').map(Number);
      return new Date(Date.UTC(y,m-1,d,0,0,0)).toLocaleDateString('ru-RU',{ timeZone:'Europe/Moscow', weekday:'long', day:'2-digit', month:'long' });
    }
    dateEl.value = mskTodayIso();
    dateLabel.textContent = `Дата: ${ruDateLabel(dateEl.value)}`;
    dateEl.addEventListener('change', () => {
      dateLabel.textContent = `Дата: ${ruDateLabel(dateEl.value)}`;
      loadSlots(dateEl.value);
    });

    subjectsEl.addEventListener('click', (e) => {
      const btn = e.target.closest('.subj'); if (!btn) return;
      document.querySelectorAll('.subj').forEach(x => x.classList.remove('active'));
      btn.classList.add('active');
      selectedSubject = btn.dataset.value || 'Математика';
      if (selected) selectSlot(document.querySelector('.slot.selected'), selected);
    });

    async function apiGetSlots(dateISO){
      const r = await fetch(`${API}?action=slots&date=${encodeURIComponent(dateISO)}`);
      return r.json();
    }
    async function apiPost(action, obj){
      const r = await fetch(API, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify({ action, ...obj }) });
      return r.json();
    }

    async function loadSlots(dateISO){
      slots.innerHTML = '';
      slotsStatus.style.display = '';
      selected = null; if (inTG) tg.MainButton.hide();

      try{
        const res = await apiGetSlots(dateISO);
        slotsStatus.style.display = 'none';
        if (!res.ok) throw new Error(res.error||'Ошибка');
        const arr = res.slots || [];
        if (!arr.length){ slots.innerHTML = `<div class="muted">На выбранную дату свободных слотов нет.</div>`; return; }
        slots.innerHTML = '';
        arr.forEach(s => {
          const el = document.createElement('div');
          el.className = 'slot';
          el.innerHTML = `<div class="time">${s.start}–${s.end}</div><div class="meta">${s.duration || 50} мин${s.subject ? ` • ${s.subject}` : ''}</div>`;
          el.onclick = () => selectSlot(el, s);
          slots.appendChild(el);
        });
      } catch(e){
        slotsStatus.innerHTML = `<span class="muted">Не удалось загрузить слоты</span>`;
      }
    }

    function selectSlot(el, slot){
      if (!el) el = [...document.querySelectorAll('.slot')].find(x => x.textContent.includes(`${slot.start}–${slot.end}`));
      document.querySelectorAll('.slot').forEach(x => x.classList.remove('selected'));
      if (el) el.classList.add('selected');
      selected = slot;
      if (inTG){
        tg.MainButton.setText(rescheduleFrom
          ? `Перенести на ${slot.date} ${slot.start}–${slot.end} (${selectedSubject})`
          : `Записаться: ${slot.date} ${slot.start}–${slot.end} (${selectedSubject})`);
        tg.MainButton.show();
      }
    }

    if (inTG) tg.MainButton.onClick(async () => {
      if (!selected) return;
      tg.MainButton.showProgress();
      try{
        let res;
        if (rescheduleFrom) res = await apiPost('reschedule', { initData: tg.initData, oldId: rescheduleFrom, newId: selected.id, subject: selectedSubject });
        else               res = await apiPost('book', { initData: tg.initData, slotId: selected.id, subject: selectedSubject });
        tg.MainButton.hideProgress();
        if (res.ok){
          tg.HapticFeedback.notificationOccurred('success');
          tg.showAlert(rescheduleFrom ? 'Перенос выполнен' : 'Запись подтверждена');
          rescheduleFrom = null; reschedInfo.style.display = 'none'; selected = null;
          await loadSlots(dateEl.value); switchTab('my');
        } else {
          tg.HapticFeedback.notificationOccurred('error');
          tg.showAlert('Ошибка: ' + (res.error||'')); }
      } catch(e){
        tg.MainButton.hideProgress();
        tg.showAlert('Сеть/сервер недоступны.');
      }
    });

    async function loadMy(){
      myList.innerHTML = `<div class="loading"><span class="spinner"></span><span>Загружаем…</span></div>`;
      if (!inTG){ myList.innerHTML = `<div class="muted">Откройте из Telegram</div>`; return; }
      try{
        const res = await apiPost('my', { initData: tg.initData });
        if (!res.ok) throw new Error(res.error||'');
        const arr = res.bookings || [];
        if (!arr.length){ myList.innerHTML = `<div class="muted">Ближайших записей нет.</div>`; return; }
        myList.innerHTML = '';
        arr.forEach(b => {
          const box = document.createElement('div'); box.className = 'item';
          box.innerHTML = `<div><b>${fmtDate(b.date)}</b> ${b.start}–${b.end}${b.subject?` • ${b.subject}`:''}</div>`;
          const actions = document.createElement('div'); actions.className = 'actions';
          const btnMove = document.createElement('button'); btnMove.className='btn'; btnMove.textContent='Перенести'; btnMove.onclick = () => startReschedule(b);
          const btnCancel = document.createElement('button'); btnCancel.className='btn destructive'; btnCancel.textContent='Отменить'; btnCancel.onclick = () => confirmCancel(b.id);
          actions.appendChild(btnMove); actions.appendChild(btnCancel); box.appendChild(actions); myList.appendChild(box);
        });
      } catch(e){
        myList.innerHTML = `<div class="muted">Не удалось загрузить</div>`;
      }
    }

    function confirmCancel(slotId){
      if (!inTG) return;
      tg.showPopup({ title:'Отмена записи', message:'Точно отменить?',
        buttons:[{id:'yes', type:'destructive', text:'Отменить'}, {id:'no', type:'default', text:'Оставить'}]
      }, async id => {
        if (id!=='yes') return;
        const res = await apiPost('cancel', { initData: tg.initData, slotId });
        if (res.ok){ tg.HapticFeedback.notificationOccurred('success'); loadMy(); loadSlots(dateEl.value); }
        else { tg.HapticFeedback.notificationOccurred('error'); tg.showAlert('Ошибка: ' + (res.error||'')); }
      });
    }

    function startReschedule(b){
      rescheduleFrom = b.id;
      reschedInfo.style.display = '';
      reschedInfo.textContent = `Переносим: ${fmtDate(b.date)} ${b.start}–${b.end}. Выберите новый свободный слот.`;
      switchTab('book');
      if (inTG) tg.MainButton.hide();
      const btn = [...document.querySelectorAll('.subj')].find(x => (x.dataset.value||'') === (b.subject||''));
      if (btn){ document.querySelectorAll('.subj').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); selectedSubject = b.subject; }
    }

    function fmtDate(ymd){
      const [y,m,d]=ymd.split('-').map(Number);
      return new Date(Date.UTC(y,m-1,d,0,0,0)).toLocaleDateString('ru-RU',{ timeZone:'Europe/Moscow', day:'2-digit', month:'long' });
    }

    // AUTO-BIND BY start_param (t.me/... ?startapp=bindt<token>)
    (async function maybeBindByStartParam(){
      if (!inTG || !tg || !tg.initDataUnsafe) return;
      const sp = String(tg.initDataUnsafe.start_param || '');
      if (!sp || !sp.startsWith('bindt')) return;

      try{
        const linkToken = sp.slice(5);
        const res = await apiPost('bind', { initData: tg.initData, linkToken });
        if (res.ok) {
          if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
          const when = res.startIso ? new Date(res.startIso) : null;
          const whenLabel = when
            ? when.toLocaleString('ru-RU', { timeZone:'Europe/Moscow', day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' }) + ' МСК'
            : '';
          tg.showAlert('Запись привязана к вашему Telegram.' + (whenLabel ? '\n' + whenLabel + (res.subject ? ' • ' + res.subject : '') : ''));
          switchTab('my');
          loadMy();
        } else {
          if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
          tg.showAlert('Не удалось привязать запись: ' + (res.error || 'ошибка'));
        }
      } catch(e){
        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
        tg.showAlert('Сеть/сервер недоступны.');
      }
    })();

    loadSlots(dateEl.value);
  </script>
</body>
</html>







